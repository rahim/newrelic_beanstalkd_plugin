#! /usr/bin/env ruby

require 'rubygems'
require 'newrelic_plugin'
require 'beaneater'

module BeanstalkdPlugin
  class Agent < NewRelic::Plugin::Agent::Base
    agent_guid 'io.joos.newrelic.plugin.beanstalkd'
    agent_version '0.0.3'
    agent_config_options :name, :host, :port

    def initialize context, options = {}
      options[:name] ||= 'Beanstalkd'
      options[:host] ||= 'localhost'
      options[:port] ||= 11300

      super
    end

    agent_human_labels('Beanstalkd') do
      "#{@name} (#{@host}:#{@port})"
    end

    def poll_cycle
      beanstalkd = Beaneater::Pool.new(["#{@host}:#{@port}"])

      tubes = beanstalkd.tubes.all

      tubes.each do |tube|
        report_tube tube.stats
      end

      report_server beanstalkd.stats

      beanstalkd.close
    end

    def report_tube(stats)
      report_tube_metrics "Tubes/#{stats['name']}", stats
    end

    def report_server(stats)
      report_server_metrics "Server", stats
    end

    # These are sub categorised by the tube name
    def report_tube_metrics(metric, stats)
      metric_prefix = "Beanstalkd/#{metric}/"

      percent_busy = stats[:current_watching] > 0 ? (stats[:current_jobs_reserved] / stats[:current_watching]) * 100 : 0
      percent_idle = 100 - percent_busy

      report_metric metric_prefix + 'Jobs/Urgent',         nil, stats[:current_jobs_urgent]
      report_metric metric_prefix + 'Jobs/Ready',          nil, stats[:current_jobs_ready]
      report_metric metric_prefix + 'Jobs/Reserved',       nil, stats[:current_jobs_reserved]
      report_metric metric_prefix + 'Jobs/Delayed',        nil, stats[:current_jobs_delayed]
      report_metric metric_prefix + 'Jobs/Buried',         nil, stats[:current_jobs_buried]

      report_metric metric_prefix + 'TotalJobs',           nil, stats[:total_jobs]

      report_metric metric_prefix + 'Current/Using',       nil, stats[:current_using]
      report_metric metric_prefix + 'Current/Waiting',     nil, stats[:current_waiting]
      report_metric metric_prefix + 'Current/Watching',    nil, stats[:current_watching]

      report_metric metric_prefix + 'JobsReadyPerWorker',  nil, (stats[:current_jobs_ready] / stats[:current_watching]) if stats[:current_watching] > 0

      report_metric metric_prefix + 'Workers/PercentBusy', nil, percent_busy
      report_metric metric_prefix + 'Workers/PercentIdle', nil, percent_idle
    end

    def report_server_metrics(metric, stats)
      metric_prefix = "Beanstalkd/#{metric}/"

      percent_busy = stats[:current_workers] > 0 ? (stats[:current_jobs_reserved] / stats[:current_workers]) * 100 : 0
      percent_idle = 100 - percent_busy

      report_metric metric_prefix + 'Jobs/Urgent',         nil, stats[:current_jobs_urgent]
      report_metric metric_prefix + 'Jobs/Ready',          nil, stats[:current_jobs_ready]
      report_metric metric_prefix + 'Jobs/Reserved',       nil, stats[:current_jobs_reserved]
      report_metric metric_prefix + 'Jobs/Delayed',        nil, stats[:current_jobs_delayed]
      report_metric metric_prefix + 'Jobs/Buried',         nil, stats[:current_jobs_buried]

      report_metric metric_prefix + 'TotalJobs',           nil, stats[:total_jobs]

      report_metric metric_prefix + 'Current/Using',       nil, stats[:current_using]
      report_metric metric_prefix + 'Current/Waiting',     nil, stats[:current_waiting]
      report_metric metric_prefix + 'Current/Workers',     nil, stats[:current_workers]
      report_metric metric_prefix + 'Current/Tubes',       nil, stats[:current_tubes]
      report_metric metric_prefix + 'Current/Connections', nil, stats[:current_connections]
      report_metric metric_prefix + 'Current/Producers',   nil, stats[:current_producers]

      report_metric metric_prefix + 'Uptime',              's', stats[:uptime]

      report_metric metric_prefix + 'JobsReadyPerWorker',  nil, (stats[:current_jobs_ready] / stats[:current_workers]) if stats[:current_workers] > 0

      report_metric metric_prefix + 'Workers/PercentBusy', nil, percent_busy
      report_metric metric_prefix + 'Workers/PercentIdle', nil, percent_idle
    end
  end

  #
  # Register the agent with the component
  #
  NewRelic::Plugin::Setup.install_agent :beanstalkd, self

  #
  # Launch the agent
  #
  NewRelic::Plugin::Run.setup_and_run
end
